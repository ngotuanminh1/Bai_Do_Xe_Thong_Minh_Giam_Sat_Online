<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kh√°ch h√†ng - ƒê·∫∑t ch·ªó ƒë·ªó xe</title>
  <style>
    body {

      /* Reset c∆° b·∫£n */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: #f0f2f5;
        padding: 30px 20px;
        color: #333;
        font-size: 16px;
        line-height: 1.5;
      }

      .container {
        max-width: 420px;
        margin: 0 auto;
        background: #fff;
        padding: 30px 25px;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease;
      }

      .container:hover {
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      header {
        text-align: center;
        margin-bottom: 25px;
      }

      .title {
        font-size: 28px;
        font-weight: 700;
        color: #222;
        letter-spacing: 1.2px;
        margin-bottom: 6px;
        user-select: none;
      }

      #parkingStatusCard {
        display: flex;
        flex-direction: column;
        /* ƒê·ªïi sang ch·∫ø ƒë·ªô c·ªôt ƒë·ªÉ c√°c √¥ x·∫øp d∆∞·ªõi nhau */
        align-items: stretch;
        /* ƒê·∫£m b·∫£o c√°c √¥ chi·∫øm h·∫øt chi·ªÅu r·ªông */
        margin-top: 20px;
      }

      #parkingStatusCard h3 {
        margin-bottom: 15px;
        text-align: center;
      }

      #parkingStatusCard p {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        font-weight: 600;
        color: #333;
        transition: all 0.3s ease;
        margin-bottom: 10px;
        /* Kho·∫£ng c√°ch gi·ªØa c√°c √¥ */
      }

      #parkingStatusCard p span {
        font-weight: bold;
        color: #2563eb;
        font-size: 18px;
      }

      /* M√†u s·∫Øc cho t·ª´ng √¥ */
      #totalSlots {
        background-color: #e7f5ff;
        color: #16a34a;
        /* Xanh l√° */
      }

      #occupiedSlots {
        background-color: #fff8e1;
        color: #f59e0b;
        /* M√†u v√†ng */
      }

      #freeSlots {
        background-color: #fef2f2;
        color: #ef4444;
        /* M√†u ƒë·ªè */
      }

      /* Hi·ªáu ·ª©ng hover */
      #parkingStatusCard p:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }


      .pill {
        display: inline-block;
        background: linear-gradient(90deg, #4f46e5, #3b82f6);
        color: #fff;
        padding: 6px 18px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        user-select: none;
      }

      .card {
        margin-top: 15px;
      }

      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        width: 100%;
      }

      button:hover {
        background: #2563eb;
        box-shadow: 0 8px 16px rgba(37, 99, 235, 0.4);
      }

      button:active {
        background: #1d4ed8;
        box-shadow: 0 4px 8px rgba(29, 78, 216, 0.6);
      }

      .form-container {
        margin-top: 20px;
      }

      .form-container h3 {
        margin-bottom: 14px;
        color: #1e40af;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #374151;
        user-select: none;
      }

      input,
      select {
        width: 100%;
        padding: 10px 14px;
        border: 1.8px solid #d1d5db;
        border-radius: 8px;
        font-size: 15px;
        color: #1f2937;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        outline-offset: 2px;
      }

      input:focus,
      select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
      }

      #accountInfo,
      #paymentInfo,
      #qrResult {
        margin-top: 25px;
        padding: 20px;
        background: #f3f4f6;
        border-radius: 12px;
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.03);
        font-size: 15px;
        color: #4b5563;
        line-height: 1.6;
      }

      #accountInfo h3,
      #paymentInfo h3 {
        color: #2563eb;
        font-weight: 700;
        margin-bottom: 12px;
      }

      #paymentInfo ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 12px;
      }

      #paymentInfo ul li {
        margin-bottom: 8px;
      }

      #paymentInfo ul li strong {
        color: #1e3a8a;
      }

      #qrResult img {
        margin-top: 15px;
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 14px rgba(59, 130, 246, 0.2);
        user-select: none;
      }

      /* Responsive */
      @media (max-width: 480px) {
        body {
          padding: 20px 15px;
        }

        .container {
          padding: 20px 18px;
        }

        button {
          font-size: 15px;
        }

        .title {
          font-size: 24px;
        }
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1 class="title">üöó B√£i ƒê·ªó Xe</h1>
      <span class="pill">Kh√°ch h√†ng</span>
    </header>
    <div class="card" id="parkingStatusCard">
      <h3>üö¶ Tr·∫°ng th√°i b√£i ƒë·ªó</h3>
      <p id="totalSlots">T·ªïng ch·ªó: <span>-</span></p>
      <p id="occupiedSlots">ƒê√£ ƒë·ªó: <span>-</span></p>
      <p id="freeSlots">C√≤n tr·ªëng: <span>-</span></p>
    </div>



    <div class="card reserve">
      <button id="openFormBtn">üìù ƒê·∫∑t ch·ªó</button>

      <div class="form-container" id="formContainer" style="display:none;">
        <h3>Th√¥ng tin ƒë·∫∑t ch·ªó</h3>
        <label for="name">T√™n</label>
        <input type="text" id="name" placeholder="Nh·∫≠p t√™n..." />
        <label for="license">Bi·ªÉn s·ªë xe</label>
        <input type="text" id="license" placeholder="Nh·∫≠p bi·ªÉn s·ªë xe..." />

        <label for="slotSelect">Ch·ªçn ch·ªó ƒë·ªó (slot tr·ªëng)</label>
        <select id="slotSelect">
          <option value="">ƒêang t·∫£i danh s√°ch ch·ªó tr·ªëng...</option>
        </select>

        <button id="reserveBtn">X√°c nh·∫≠n</button>
      </div>

      <div id="accountInfo" style="display:none;">
        <h3>üë§ Th√¥ng tin t√†i kho·∫£n c√° nh√¢n</h3>
        <p><strong>T√™n:</strong> <span id="displayName"></span></p>
        <p><strong>Bi·ªÉn s·ªë xe:</strong> <span id="displayLicense"></span></p>
        <p><em>‚è≥ ƒêang ch·ªù admin x√°c nh·∫≠n ƒë·∫∑t ch·ªó v√† thanh to√°n...</em></p>
      </div>

      <div id="paymentInfo" style="display:none;">
        <h3>üí≥ Thanh to√°n</h3>
        <p>Vui l√≤ng chuy·ªÉn kho·∫£n ƒë·∫øn:</p>
        <ul>
          <li>Ng√¢n h√†ng: <strong>ABC Bank</strong></li>
          <li>S·ªë t√†i kho·∫£n: <strong>1234567890</strong></li>
          <li>Ch·ªß t√†i kho·∫£n: <strong>Nguy·ªÖn VƒÉn A</strong></li>
          <li>S·ªë ti·ªÅn: <strong>50.000 VND</strong></li>
          <li>N·ªôi dung: <strong>Bi·ªÉn s·ªë xe: <span id="licenseDisplay"></span></strong></li>
        </ul>
        <p><em>Sau khi chuy·ªÉn kho·∫£n, nh·∫•n "T√¥i ƒë√£ thanh to√°n" ƒë·ªÉ x√°c nh·∫≠n.</em></p>
        <button id="confirmPaymentBtn">T√¥i ƒë√£ thanh to√°n</button>
      </div>

      <div id="qrResult"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const openFormBtn = document.getElementById("openFormBtn");
      const reserveBtn = document.getElementById("reserveBtn");
      const confirmPaymentBtn = document.getElementById("confirmPaymentBtn");
      const slotSelect = document.getElementById("slotSelect");
      loadParkingStatus();
      openFormBtn.addEventListener("click", () => {
        clearAll();
        document.getElementById("formContainer").style.display = "block";
        loadAvailableSlots();
      });

      reserveBtn.addEventListener("click", reserve);
      confirmPaymentBtn.addEventListener("click", confirmPayment);

      async function loadAvailableSlots() {
        slotSelect.innerHTML = '<option value="">ƒêang t·∫£i danh s√°ch ch·ªó tr·ªëng...</option>';
        try {
          const res = await fetch('/status');
          const data = await res.json();

          if (data.slots && Array.isArray(data.slots)) {
            // L·ªçc nh·ªØng slot tr·ªëng (gi√° tr·ªã 0)
            const availableSlots = data.slots
              .map((val, idx) => ({ val, idx }))
              .filter(s => s.val === 0);

            if (availableSlots.length === 0) {
              slotSelect.innerHTML = '<option value="">H·∫øt ch·ªó tr·ªëng</option>';
              slotSelect.disabled = true;
            } else {
              slotSelect.disabled = false;
              slotSelect.innerHTML = '<option value="">-- Ch·ªçn ch·ªó ƒë·ªó --</option>';
              availableSlots.forEach(slot => {
                slotSelect.innerHTML += `<option value="${slot.idx}">Ch·ªó s·ªë ${slot.idx + 1}</option>`;
              });
            }
          } else {
            slotSelect.innerHTML = '<option value="">Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch ch·ªó tr·ªëng</option>';
            slotSelect.disabled = true;
          }
        } catch (error) {
          console.error("L·ªói khi t·∫£i slot:", error);
          slotSelect.innerHTML = '<option value="">L·ªói khi t·∫£i ch·ªó tr·ªëng</option>';
          slotSelect.disabled = true;
        }
      }

      async function reserve() {
        const name = document.getElementById("name").value.trim();
        const license = document.getElementById("license").value.trim();
        const slotIndex = slotSelect.value;

        if (!name || !license) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
          return;
        }
        if (slotIndex === "") {
          alert("Vui l√≤ng ch·ªçn ch·ªó ƒë·ªó");
          return;
        }

        try {
          const res = await fetch("/pre-reserve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, license, slotIndex: Number(slotIndex) })
          });
          const data = await res.json();

          if (data.success) {
            document.getElementById("formContainer").style.display = "none";
            document.getElementById("accountInfo").style.display = "block";
            document.getElementById("paymentInfo").style.display = "block";
            document.getElementById("licenseDisplay").innerText = license;
            document.getElementById("qrResult").innerHTML = "";
            document.getElementById("displayName").innerText = name;
            document.getElementById("displayLicense").innerText = license;
            window.lastLicense = license;
            window.lastName = name;
          } else {
            alert(data.message || "ƒê·∫∑t ch·ªó th·∫•t b·∫°i");
          }
        } catch (err) {
          console.error("L·ªói khi g·ª≠i y√™u c·∫ßu ƒë·∫∑t ch·ªó:", err);
          alert("ƒê·∫∑t ch·ªó th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
      }
      async function loadParkingStatus() {
        try {
          const res = await fetch("/status"); // API l·∫•y tr·∫°ng th√°i b√£i ƒë·ªó
          const data = await res.json();

          if (data.tongCho) {
            document.getElementById("totalSlots").innerHTML = `T·ªïng ch·ªó: <span>${data.tongCho}</span>`;
          }

          if (Array.isArray(data.slots)) {
            const occupiedCount = data.slots.filter(s => s === 2).length; // S·ªë l∆∞·ª£ng xe ƒë√£ ƒë·ªó
            const freeCount = data.slots.filter(s => s === 0).length; // S·ªë l∆∞·ª£ng ch·ªó tr·ªëng

            document.getElementById("occupiedSlots").innerHTML = `ƒê√£ ƒë·ªó: <span>${occupiedCount}</span>`;
            document.getElementById("freeSlots").innerHTML = `C√≤n tr·ªëng: <span>${freeCount}</span>`;
          }
        } catch (error) {
          console.error("L·ªói khi t·∫£i tr·∫°ng th√°i b√£i ƒë·ªó:", error);
          alert("Kh√¥ng th·ªÉ t·∫£i tr·∫°ng th√°i b√£i ƒë·ªó. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
      }


      async function confirmPayment() {
        const license = window.lastLicense;
        if (!license) {
          alert("Kh√¥ng t√¨m th·∫•y bi·ªÉn s·ªë xe");
          return;
        }

        try {
          const res = await fetch(`/check-payment?license=${encodeURIComponent(license)}`);
          const data = await res.json();

          if (data.success) {
            document.getElementById("qrResult").innerHTML = `
          <p>${data.message}</p>
          <img src="${data.qrUrl}" alt="QR Code" />
        `;
            document.getElementById("paymentInfo").style.display = "none";
            document.getElementById("accountInfo").style.display = "none";
            document.getElementById("formContainer").style.display = "none";
          } else {
            alert(data.message || "Thanh to√°n ch∆∞a ƒë∆∞·ª£c x√°c nh·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau.");
          }
        } catch (err) {
          console.error("L·ªói khi ki·ªÉm tra thanh to√°n:", err);
          alert("Kh√¥ng th·ªÉ ki·ªÉm tra thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      }

      function clearAll() {
        document.getElementById("formContainer").style.display = "none";
        document.getElementById("accountInfo").style.display = "none";
        document.getElementById("paymentInfo").style.display = "none";
        document.getElementById("qrResult").innerHTML = "";
        window.lastLicense = null;
        window.lastName = null;
        document.getElementById("name").value = "";
        document.getElementById("license").value = "";
        slotSelect.innerHTML = "";
        slotSelect.disabled = false;
      }
    });
  </script>
</body>

</html>